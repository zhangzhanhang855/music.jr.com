<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ–—åœ°ä¸» 1v1 Â· å·…å³°ç¦å¿Œèµ› (å¤šå‰¯ç‰Œç‰ˆ)</title>
    <style>
        :root { --bg: #121212; --gold: #c5a059; --card-w: 65px; --card-h: 90px; }
        body { margin: 0; background: var(--bg); font-family: "Consolas", sans-serif; color: white; overflow: hidden; }
        
        #header { height: 60px; background: #222; display: flex; align-items: center; justify-content: space-around; border-bottom: 2px solid var(--gold); }
        
        .game-area { height: calc(100vh - 60px); position: relative; display: flex; flex-direction: column; }

        /* æ‰‹ç‰Œæ»šåŠ¨å®¹å™¨ */
        .hand-container { 
            width: 100%; overflow-x: auto; overflow-y: hidden; white-space: nowrap; 
            padding: 20px 0; scrollbar-width: thin;
        }
        #hand-0 { height: 140px; background: rgba(255,255,255,0.05); }
        #hand-1 { height: 100px; } /* ç”µè„‘æ‰‹ç‰ŒåŒº */

        .card {
            display: inline-flex; width: var(--card-w); height: var(--card-h); 
            background: white; border-radius: 4px; color: black; margin-left: -40px;
            flex-direction: column; padding: 5px; box-sizing: border-box;
            border: 1px solid #999; vertical-align: top; cursor: pointer; transition: 0.2s;
        }
        .card:first-child { margin-left: 10px; }
        .card.selected { transform: translateY(-30px); border: 3px solid #ff0055; box-shadow: 0 0 15px #ff0055; }
        .card.red { color: #ff0000; }
        .card.back { background: #333; color: transparent; border: 1px solid #555; }
        .card .v { font-size: 20px; font-weight: bold; line-height: 1; }

        /* æ¡Œé¢å¯¹æˆ˜åŒº */
        #desk { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px; }
        .desk-slot { min-height: 100px; display: flex; justify-content: center; width: 100%; border-top: 1px solid #333; }

        #controls { position: fixed; bottom: 180px; width: 100%; display: flex; justify-content: center; gap: 20px; pointer-events: none; opacity: 0; }
        #controls.active { pointer-events: auto; opacity: 1; }
        button { padding: 10px 40px; border-radius: 5px; border: none; background: var(--gold); color: black; font-weight: bold; cursor: pointer; }
        button:disabled { background: #444; color: #888; }
        
        .status-bar { position: absolute; top: 10px; right: 20px; color: var(--gold); }
    </style>
</head>
<body>

<div id="header">
    <div>æ¨¡å¼: 1v1 å·…å³°èµ›</div>
    <div>
        ç‰Œå †: <select id="deck-num"><option value="3">3 å‰¯ç‰Œ (162å¼ )</option><option value="4">4 å‰¯ç‰Œ (216å¼ )</option></select>
    </div>
    <button onclick="initGame()">å¼€å§‹å®æ€</button>
</div>

<div class="game-area">
    <div id="hand-1" class="hand-container"></div>
    
    <div id="desk">
        <div id="desk-1" class="desk-slot"></div>
        <div id="desk-0" class="desk-slot"></div>
    </div>

    <div id="controls">
        <button onclick="handlePlay()">å‡ºç‰Œ (PLAY)</button>
        <button id="btn-pass" onclick="handlePass()">ä¸è¦ (PASS)</button>
    </div>
    <div id="hand-0" class="hand-container"></div>
</div>

<script>
const POWER = { '3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':10,'J':11,'Q':12,'K':13,'A':14,'2':15,'å°ç‹':16,'å¤§ç‹':17 };
let state = { hands: [[], []], last: null, turn: 0, selected: new Set() };

function initGame() {
    const num = parseInt(document.getElementById('deck-num').value);
    let deck = [];
    for(let i=0; i<num; i++) {
        for(let v in POWER) {
            if(v.includes('ç‹')) deck.push({v, p:POWER[v], s:'ğŸƒ', c:v==='å¤§ç‹'?'red':'black'});
            else ['â™ ','â™¥','â™£','â™¦'].forEach(s => deck.push({v, p:POWER[v], s, c:(s==='â™¥'||s==='â™¦'?'red':'black')}));
        }
    }
    deck.sort(() => Math.random() - 0.5);
    
    // 1v1 å¹³åˆ†æ‰€æœ‰ç‰Œ
    const half = Math.floor(deck.length / 2);
    state.hands = [
        deck.slice(0, half).sort((a,b)=>b.p-a.p),
        deck.slice(half).sort((a,b)=>b.p-a.p)
    ];
    state.last = null; state.turn = 0; state.selected.clear();
    
    renderAll();
    checkTurn();
}

// é«˜çº§ç‰Œå‹å¼•æ“ï¼šå¤„ç†å¤šå‰¯ç‰Œä¸‹çš„ç‚¸å¼¹
function getInfo(cards) {
    if(!cards.length) return null;
    let counts = {};
    cards.forEach(c => counts[c.p] = (counts[c.p] || 0) + 1);
    let sorted = Object.entries(counts).map(e=>({p:Number(e[0]), c:e[1]})).sort((a,b)=>b.c - a.c || b.p - a.p);
    let len = cards.length;
    let main = sorted[0];

    // ç‚¸å¼¹ï¼šå¤šå‰¯ç‰Œä¸‹ï¼Œ4å¼ åŠä»¥ä¸Šç›¸åŒå³ä¸ºç‚¸å¼¹ï¼Œå¼ æ•°å¤šè€…å¤§ï¼Œå¼ æ•°åŒåˆ™æ¯”ç‚¹æ•°
    if(main.c === len && len >= 4) return { type: 'bomb', p: main.p, weight: len * 100 + main.p };
    // ç‹ç‚¸ï¼š2å¼ åŠä»¥ä¸Šç‹å³ä¸ºç‹ç‚¸
    let jokers = cards.filter(c => c.p >= 16);
    if(jokers.length === len && len >= 2) return { type: 'bomb', p: 99, weight: len * 1000 + 99 };

    if(len === 1) return { type: 'single', p: main.p };
    if(len === 2 && main.c === 2) return { type: 'pair', p: main.p };
    if(len === 3 && main.c === 3) return { type: 'trio', p: main.p };
    if(len === 4 && main.c === 3) return { type: 'trio_1', p: main.p };
    if(len === 5 && main.c === 3 && sorted[1].c === 2) return { type: 'trio_2', p: main.p };

    // é¡ºå­
    if(len >= 5 && sorted.every(e => e.c === 1)) {
        let ps = sorted.map(e=>e.p).sort((a,b)=>a-b);
        if(ps[len-1] < 15 && ps[len-1]-ps[0] === len-1) return { type: 'straight', p: ps[0], len };
    }
    return null;
}

// é­”é¬¼çº§ AIï¼šè´ªå©ªæœç´¢+é˜²å®ˆé€»è¾‘
function aiThink() {
    const hand = state.hands[1];
    let toPlay = [];

    if(!state.last || state.last.player === 1) {
        // ä¸»åŠ¨å‡ºç‰Œï¼šä¼˜å…ˆå‡ºé¡ºå­ï¼Œå¦åˆ™å‡ºæœ€å°å•å¼ /å¯¹å­
        toPlay = findBestLeading(hand);
    } else {
        const lastI = getInfo(state.last.cards);
        // 1. å°è¯•åŒç‰Œå‹å‹åˆ¶
        toPlay = findResponse(hand, lastI);
        // 2. å¦‚æœæ²¡æ³•åŒå‹å‹ï¼Œä¸”å¯¹æ–¹æ‰‹ç‰Œå˜å°‘ï¼Œè€ƒè™‘äº¤ç‚¸å¼¹
        if(!toPlay.length && (state.hands[0].length < 15 || lastI.p > 14)) {
            toPlay = findBomb(hand, lastI);
        }
    }

    if(toPlay.length) execute(toPlay);
    else handlePass();
}

function findBestLeading(hand) {
    // æœç´¢é¡ºå­
    for(let l=12; l>=5; l--) {
        let res = [];
        for(let p=3; p<=14-l+1; p++) {
            let temp = [];
            for(let i=0; i<l; i++) {
                let found = hand.find(c => c.p === p+i);
                if(found) temp.push(found); else break;
            }
            if(temp.length === l) return temp;
        }
    }
    // æœç´¢å¯¹å­
    for(let i=hand.length-1; i>0; i--) if(hand[i].p === hand[i-1].p) return [hand[i], hand[i-1]];
    return [hand[hand.length-1]];
}

function findResponse(hand, lastI) {
    // é’ˆå¯¹å•å¼ ã€å¯¹å­ã€ä¸‰æ¡çš„å¿«é€Ÿæœç´¢
    if(lastI.type === 'single' || lastI.type === 'pair' || lastI.type === 'trio') {
        let need = (lastI.type === 'single' ? 1 : (lastI.type === 'pair' ? 2 : 3));
        let counts = {}; hand.forEach(c => counts[c.p] = (counts[c.p]||0)+1);
        let bestP = Object.keys(counts).filter(p => counts[p] >= need && Number(p) > lastI.p).sort((a,b)=>a-b);
        if(bestP.length) return hand.filter(c => c.p == bestP[0]).slice(0, need);
    }
    return [];
}

function findBomb(hand, lastI) {
    let counts = {}; hand.forEach(c => counts[c.p] = (counts[c.p]||0)+1);
    // æ‰¾ç‚¹æ•°ç‚¸å¼¹
    for(let n=4; n<=8; n++) {
        let best = Object.keys(counts).filter(p => counts[p] >= n).sort((a,b)=>a-b);
        for(let p of best) {
            let info = { type: 'bomb', weight: n * 100 + Number(p) };
            if(!lastI || lastI.type !== 'bomb' || info.weight > lastI.weight) return hand.filter(c => c.p == p).slice(0, n);
        }
    }
    // æ‰¾ç‹ç‚¸
    let jokers = hand.filter(c => c.p >= 16);
    if(jokers.length >= 2) {
        if(!lastI || lastI.type !== 'bomb' || (jokers.length * 1000 + 99) > (lastI.weight || 0)) return jokers;
    }
    return [];
}

// --- åŸºç¡€æµç¨‹ ---
function renderAll() {
    const h0 = document.getElementById('hand-0');
    h0.innerHTML = state.hands[0].map((c, i) => `
        <div class="card ${c.c} ${state.selected.has(i)?'selected':''}" onclick="toggleCard(${i})">
            <span class="v">${c.v}</span><span>${c.s}</span>
        </div>
    `).join('');
    
    document.getElementById('hand-1').innerHTML = state.hands[1].map(() => `<div class="card back"></div>`).join('');
    document.getElementById('controls').className = state.turn === 0 ? 'active' : '';
    document.getElementById('btn-pass').disabled = !state.last || state.last.player === 0;
}

function toggleCard(i) {
    if(state.selected.has(i)) state.selected.delete(i); else state.selected.add(i);
    renderAll();
}

function handlePlay() {
    let cards = Array.from(state.selected).map(i => state.hands[0][i]);
    let info = getInfo(cards);
    if(!info) return alert("æ— æ•ˆç‰Œå‹");

    if(state.last && state.last.player !== 0) {
        let l = getInfo(state.last.cards);
        if(info.type === 'bomb') {
            if(l.type === 'bomb' && info.weight <= l.weight) return alert("ç‚¸å¼¹å¤ªå°");
        } else {
            if(info.type !== l.type || info.len !== l.len || info.p <= l.p) return alert("å‹ä¸ä½");
        }
    }
    execute(cards);
}

function handlePass() {
    document.getElementById(`desk-${state.turn}`).innerHTML = "<b style='color:white'>ä¸è¦ PASS</b>";
    nextTurn();
}

function execute(cards) {
    state.hands[state.turn] = state.hands[state.turn].filter(c => !cards.includes(c));
    state.last = { player: state.turn, cards };
    document.getElementById(`desk-${state.turn}`).innerHTML = cards.map(c => `
        <div class="card ${c.c}" style="margin-left:-45px; transform:scale(0.85)">
            <span class="v">${c.v}</span><span>${c.s}</span>
        </div>
    `).join('');
    if(state.hands[state.turn].length === 0) return alert(state.turn === 0 ? "ä½ èµ¢äº†ï¼äººç±»ä¹‹å…‰ï¼" : "é­”é¬¼AIè·èƒœï¼Œäººç±»æ¯ç­ã€‚");
    state.selected.clear();
    nextTurn();
}

function nextTurn() {
    state.turn = 1 - state.turn;
    document.getElementById(`desk-${state.turn}`).innerHTML = "";
    renderAll();
    checkTurn();
}

function checkTurn() {
    if(state.turn === 1) setTimeout(aiThink, 1200);
}

initGame();
</script>
</body>
</html>
