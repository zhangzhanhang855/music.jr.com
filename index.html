<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–—åœ°ä¸»Â·æ™ºèƒœç‰ˆ - äººæœºå¯¹æˆ˜</title>
    <style>
        :root {
            --bg: #1a472a;
            --card-w: 80px;
            --card-h: 110px;
            --gold: #ffd700;
        }
        body { margin: 0; background: var(--bg); font-family: "PingFang SC", "Microsoft YaHei"; color: white; overflow: hidden; user-select: none; }
        
        /* é¡¶éƒ¨ä¿¡æ¯æ  */
        #header { height: 50px; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: space-around; padding: 0 20px; }
        .dizhu-view { display: flex; gap: 5px; }
        .tiny-card { width: 30px; height: 40px; background: white; border-radius: 3px; color: black; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* æ¸¸æˆä¸»èˆå° */
        #stage { height: calc(100vh - 50px); position: relative; }
        .player-info { position: absolute; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 15px; font-size: 14px; border: 1px solid var(--gold); }
        #info-1 { top: 20%; left: 20px; } /* ç”µè„‘1 (å·¦) */
        #info-2 { top: 20%; right: 20px; } /* ç”µè„‘2 (å³) */

        /* æ‰‹ç‰ŒåŒºåŸŸ */
        .hand { position: absolute; display: flex; justify-content: center; transition: 0.3s; }
        #hand-0 { bottom: 30px; width: 100%; height: var(--card-h); z-index: 10; }
        #hand-1 { left: 50px; top: 30%; flex-direction: column; }
        #hand-2 { right: 50px; top: 30%; flex-direction: column; }

        /* å¡ç‰Œæ ·å¼ */
        .card {
            width: var(--card-w); height: var(--card-h);
            background: white; border-radius: 8px; border: 1px solid #999;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.4);
            position: relative; margin-left: -45px; /* å æ”¾ */
            display: flex; flex-direction: column; padding: 5px; box-sizing: border-box;
            cursor: pointer; transition: transform 0.1s, margin-top 0.2s;
            color: black;
        }
        #hand-0 .card:first-child { margin-left: 0; }
        .card.selected { margin-top: -30px; border: 3px solid var(--gold); }
        .card.red { color: #d00; }
        .card.back { background: linear-gradient(135deg, #2c3e50, #000); border: 2px solid #fff; }
        .card .val { font-size: 22px; font-weight: 900; line-height: 1; }
        .card .suit { font-size: 16px; align-self: flex-start; }

        /* å‡ºç‰ŒåŒº */
        .desk-area { position: absolute; width: 300px; height: 120px; display: flex; justify-content: center; align-items: center; transform: translateX(-50%); left: 50%; }
        #desk-0 { bottom: 180px; }
        #desk-1 { top: 30%; left: 250px; }
        #desk-2 { top: 30%; left: calc(100% - 250px); }

        /* æ§åˆ¶æŒ‰é’® */
        #controls { position: absolute; bottom: 150px; width: 100%; display: flex; justify-content: center; gap: 15px; pointer-events: none; opacity: 0; transition: 0.3s; }
        #controls.active { pointer-events: auto; opacity: 1; }
        button { 
            padding: 8px 25px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 0 #b8860b; background: linear-gradient(#ffd700, #daa520);
        }
        button:active { transform: translateY(2px); box-shadow: 0 2px 0 #b8860b; }
        button:disabled { background: #888; box-shadow: 0 4px 0 #555; cursor: not-allowed; }

        select { background: #333; color: white; border: 1px solid var(--gold); padding: 5px; border-radius: 5px; }

        .msg { font-size: 24px; color: var(--gold); text-shadow: 2px 2px 4px black; }
    </style>
</head>
<body>

<div id="header">
    <div>
        éš¾åº¦: 
        <select id="diff-level">
            <option value="0">å°ç™½ (ä¹±å‡º)</option>
            <option value="1">æ–°æ‰‹ (ä¼šå‡ºå¯¹å­)</option>
            <option value="2" selected>æ™®é€š (å¹³å‡æ°´å¹³)</option>
            <option value="3">è€æ‰‹ (ç­–ç•¥æ€§è·‘ç‰Œ)</option>
            <option value="4">é«˜æ‰‹ (é˜²å®ˆä¸¥å¯†)</option>
            <option value="5">å¤§å¸ˆ (ä¼šç®—ç‰Œæ‹†ç‰Œ)</option>
            <option value="6">é­”é¬¼ (åœ°ç‹±çº§é€»è¾‘)</option>
        </select>
    </div>
    <div class="dizhu-view" id="dz-cards"></div>
    <button onclick="initGame()">é‡å¼€æ¸¸æˆ</button>
</div>

<div id="stage">
    <div id="info-1" class="player-info">ç”µè„‘1: 17å¼ </div>
    <div id="info-2" class="player-info">ç”µè„‘2: 17å¼ </div>

    <div id="hand-1" class="hand"></div>
    <div id="hand-2" class="hand"></div>
    
    <div id="desk-1" class="desk-area"></div>
    <div id="desk-2" class="desk-area"></div>
    <div id="desk-0" class="desk-area"></div>

    <div id="controls">
        <button onclick="handlePlay()">å‡ºç‰Œ</button>
        <button onclick="handlePass()">ä¸è¦</button>
    </div>

    <div id="hand-0" class="hand"></div>
</div>

<script>
/** * æ–—åœ°ä¸»æ ¸å¿ƒé€»è¾‘é‡å†™ 
 */
const CARD_MAP = { '3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':10,'J':11,'Q':12,'K':13,'A':14,'2':15,'å°ç‹':16,'å¤§ç‹':17 };
const SUITS = ['â™ ','â™¥','â™£','â™¦'];
let state = {
    hands: [[], [], []],
    dzCards: [],
    lastMove: { player: -1, cards: [], type: null, power: 0 },
    turn: 0,
    selected: new Set()
};

// --- åˆå§‹åŒ– ---
function initGame() {
    let deck = [];
    for(let v in CARD_MAP) {
        if(v === 'å°ç‹' || v === 'å¤§ç‹') {
            deck.push({v, p: CARD_MAP[v], s: 'ğŸƒ', c: v==='å¤§ç‹'?'red':'black'});
        } else {
            SUITS.forEach(s => deck.push({v, p: CARD_MAP[v], s, c: (s==='â™¥'||s==='â™¦'?'red':'black')}));
        }
    }
    deck.sort(() => Math.random() - 0.5);

    state.hands = [
        deck.slice(0, 17).sort((a,b)=>b.p-a.p),
        deck.slice(17, 34).sort((a,b)=>b.p-a.p),
        deck.slice(34, 51).sort((a,b)=>b.p-a.p)
    ];
    state.dzCards = deck.slice(51);
    // é»˜è®¤ç©å®¶æ˜¯åœ°ä¸»
    state.hands[0] = [...state.hands[0], ...state.dzCards].sort((a,b)=>b.p-a.p);
    state.turn = 0;
    state.lastMove = { player: -1, cards: [] };
    state.selected.clear();

    renderDizhu();
    renderAll();
    checkTurn();
}

// --- ç‰Œå‹åˆ¤æ–­ ---
function getCardsInfo(cards) {
    if(!cards.length) return null;
    const s = [...cards].sort((a,b)=>a.p - b.p);
    const len = s.length;
    
    if(len === 1) return { type: 'single', power: s[0].p };
    if(len === 2) {
        if(s[0].p === s[1].p) return { type: 'pair', power: s[0].p };
        if(s[0].p >= 16 && s[1].p >= 16) return { type: 'bomb', power: 99 }; // ç‹ç‚¸
    }
    if(len === 3 && s[0].p === s[2].p) return { type: 'trio', power: s[0].p };
    if(len === 4 && s[0].p === s[3].p) return { type: 'bomb', power: s[0].p };
    
    return null; // æ›´å¤š(é¡ºå­/ä¸‰å¸¦)çœç•¥ä»¥ä¾¿æ ¸å¿ƒå±•ç¤º
}

// --- AI é€»è¾‘ ---
function aiMove() {
    const level = parseInt(document.getElementById('diff-level').value);
    const hand = state.hands[state.turn];
    let toPlay = [];

    // 1. å¦‚æœæ˜¯å‡ºç‰Œæƒåœ¨æ‰‹ (è‡ªå·±å¤§æˆ–è€…æ–°å±€)
    if (state.lastMove.player === -1 || state.lastMove.player === state.turn) {
        // é­”é¬¼/å¤§å¸ˆä¼˜å…ˆå‡ºæœ€å°‘çš„ç»„åˆï¼Œå°ç™½éšä¾¿å‡ºä¸€å¼ æœ€å°çš„
        if(level >= 4) {
            const pairs = findGroup(hand, 2);
            toPlay = pairs.length > 0 ? pairs[0] : [hand[hand.length-1]];
        } else {
            toPlay = [hand[hand.length-1]];
        }
    } 
    // 2. è·Ÿç‰Œ
    else {
        const last = getCardsInfo(state.lastMove.cards);
        const myPairs = findGroup(hand, 2);
        const mySingles = hand;

        if(last.type === 'single') {
            const bigger = hand.filter(c => c.p > last.power).reverse();
            if(bigger.length > 0) {
                // éš¾åº¦ç­–ç•¥
                if(level === 0 && Math.random() > 0.4) toPlay = []; // å°ç™½ç»å¸¸å‘å‘†
                else if(level <= 2) toPlay = [bigger[0]]; // æ™®é€š: å‡ºæœ€å°çš„å‹
                else if(level >= 5 && bigger[0].p >= 15 && hand.length > 2) toPlay = []; // å¤§å¸ˆ: ä¸èˆå¾—ç”¨2å‹å°ç‰Œ
                else toPlay = [bigger[0]];
            }
        } else if(last.type === 'pair') {
            const biggerPair = myPairs.filter(p => p[0].p > last.power).reverse();
            if(biggerPair.length > 0) toPlay = biggerPair[0];
        }

        // 3. ç‚¸å¼¹é€»è¾‘ (è€æ‰‹ä»¥ä¸Šä¼šç”¨ç‚¸å¼¹)
        if(toPlay.length === 0 && level >= 3) {
            const bombs = findGroup(hand, 4);
            if(bombs.length > 0) {
                // é­”é¬¼éš¾åº¦ä¼šåœ¨ä½ å‰©ç‰Œå°‘äº3å¼ æ—¶æ‰è½°ç‚¸
                if(level < 6 || state.hands[state.lastMove.player].length < 5) toPlay = bombs[0];
            }
        }
    }

    if(toPlay.length > 0) {
        executeMove(state.turn, toPlay);
    } else {
        handlePass();
    }
}

function findGroup(hand, size) {
    let res = [];
    let counts = {};
    hand.forEach(c => counts[c.p] = (counts[c.p] || 0) + 1);
    for(let p in counts) {
        if(counts[p] >= size) {
            res.push(hand.filter(c => c.p == p).slice(0, size));
        }
    }
    return res;
}

// --- æ¸¸æˆæµç¨‹ ---
function executeMove(pIdx, cards) {
    state.hands[pIdx] = state.hands[pIdx].filter(c => !cards.includes(c));
    state.lastMove = { player: pIdx, cards: cards };
    
    // æ¸…ç©ºæ¡Œé¢ä¸Šè¯¥ä½ç½®çš„â€œä¸è¦â€
    document.getElementById(`desk-${pIdx}`).innerHTML = renderCardsHTML(cards);
    
    if(state.hands[pIdx].length === 0) {
        setTimeout(() => { alert(pIdx === 0 ? "ä½ èµ¢äº†ï¼" : `ç”µè„‘${pIdx}å·èµ¢äº†ï¼`); initGame(); }, 200);
        return;
    }
    
    nextTurn();
}

function handlePlay() {
    const cards = Array.from(state.selected).map(idx => state.hands[0][idx]);
    const info = getCardsInfo(cards);
    
    if(!info) return alert("æ— æ•ˆç‰Œå‹");
    
    if(state.lastMove.player !== -1 && state.lastMove.player !== 0) {
        const last = getCardsInfo(state.lastMove.cards);
        if(info.type !== 'bomb' && info.type !== last.type) return alert("ç‰Œå‹ä¸ç¬¦");
        if(info.power <= last.power) return alert("ä¸å¤Ÿå¤§");
    }

    state.selected.clear();
    executeMove(0, cards);
}

function handlePass() {
    if(state.lastMove.player === -1 || state.lastMove.player === state.turn) return;
    document.getElementById(`desk-${state.turn}`).innerHTML = '<div class="msg">ä¸è¦</div>';
    nextTurn();
}

function nextTurn() {
    state.turn = (state.turn + 1) % 3;
    // æ¸…é™¤è¯¥ç©å®¶ä¸Šä¸€è½®åœ¨æ¡Œä¸Šçš„ç‰Œ
    document.getElementById(`desk-${state.turn}`).innerHTML = '';
    renderAll();
    checkTurn();
}

function checkTurn() {
    const ctrl = document.getElementById('controls');
    if(state.turn === 0) {
        ctrl.classList.add('active');
    } else {
        ctrl.classList.remove('active');
        setTimeout(aiMove, 800 + Math.random() * 1000);
    }
}

// --- æ¸²æŸ“ ---
function renderAll() {
    const h0 = document.getElementById('hand-0');
    h0.innerHTML = '';
    state.hands[0].forEach((c, i) => {
        const div = document.createElement('div');
        div.className = `card ${c.c} ${state.selected.has(i)?'selected':''}`;
        div.innerHTML = `<span class="val">${c.v}</span><span class="suit">${c.s}</span>`;
        div.onclick = () => { state.selected.has(i)?state.selected.delete(i):state.selected.add(i); renderAll(); };
        h0.appendChild(div);
    });

    document.getElementById('hand-1').innerHTML = state.hands[1].map(() => '<div class="card back"></div>').join('');
    document.getElementById('hand-2').innerHTML = state.hands[2].map(() => '<div class="card back"></div>').join('');
    
    document.getElementById('info-1').innerText = `ç”µè„‘1: ${state.hands[1].length}å¼ `;
    document.getElementById('info-2').innerText = `ç”µè„‘2: ${state.hands[2].length}å¼ `;
}

function renderDizhu() {
    document.getElementById('dz-cards').innerHTML = state.dzCards.map(c => 
        `<div class="tiny-card" style="color:${c.c}">${c.v}</div>`
    ).join('');
}

function renderCardsHTML(cards) {
    return cards.map(c => `
        <div class="card ${c.c}" style="margin-left:-50px; cursor:default; transform:scale(0.8)">
            <span class="val">${c.v}</span><span class="suit">${c.s}</span>
        </div>
    `).join('');
}

initGame();
</script>
</body>
</html>
