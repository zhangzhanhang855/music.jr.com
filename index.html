<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ–—åœ°ä¸» 1v1 Â· æš´å‡»ä¿®å¤ç‰ˆ</title>
    <style>
        :root { 
            --bg: #0f172a; 
            --gold: #fbbf24; 
            --card-w: 80px; 
            --card-h: 115px;
            --danger: #ef4444;
        }
        body { margin: 0; background: var(--bg); font-family: "Segoe UI", sans-serif; color: white; overflow: hidden; }

        /* ç‰¹æ•ˆåŠ¨ç”» */
        @keyframes shake {
            0%, 100% { transform: translate(0, 0); }
            10%, 30%, 50%, 70%, 90% { transform: translate(-2px, -2px); }
            20%, 40%, 60%, 80% { transform: translate(2px, 2px); }
        }
        .bomb-shake { animation: shake 0.4s ease-in-out; }
        
        @keyframes flash {
            0% { background: var(--bg); }
            50% { background: #450a0a; }
            100% { background: var(--bg); }
        }
        .bomb-flash { animation: flash 0.4s ease-in-out; }

        #stage { height: 100vh; position: relative; display: flex; flex-direction: column; }

        /* é¡¶éƒ¨ä¿¡æ¯ */
        #header { 
            height: 50px; background: rgba(30, 41, 59, 0.9); 
            display: flex; align-items: center; justify-content: space-around;
            border-bottom: 1px solid #334155;
        }

        /* æŒ‰é’® UI */
        .btn-group { position: absolute; bottom: 170px; width: 100%; display: flex; justify-content: center; gap: 20px; visibility: hidden; }
        .btn-group.active { visibility: visible; }

        button { 
            padding: 10px 30px; border-radius: 8px; border: none; font-weight: bold; 
            cursor: pointer; transition: 0.2s;
            background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            color: #451a03; box-shadow: 0 4px 0 #92400e;
        }
        button:hover { filter: brightness(1.1); transform: translateY(-1px); }
        button:active { transform: translateY(2px); box-shadow: 0 0 0 transparent; }
        button:disabled { background: #475569; box-shadow: 0 4px 0 #1e293b; color: #94a3b8; cursor: not-allowed; }
        
        #btn-pass { background: linear-gradient(135deg, #94a3b8 0%, #475569 100%); color: white; box-shadow: 0 4px 0 #1e293b; }

        /* å¡ç‰Œæ ·å¼ */
        .hand { width: 100%; display: flex; justify-content: center; padding: 15px 0; min-height: 120px; }
        .card {
            width: var(--card-w); height: var(--card-h); background: white; border-radius: 8px;
            color: black; margin-left: -50px; position: relative;
            display: flex; flex-direction: column; padding: 6px; box-sizing: border-box;
            box-shadow: -2px 0 8px rgba(0,0,0,0.4); transition: transform 0.15s;
            cursor: pointer; border: 1px solid #94a3b8;
        }
        .card:first-child { margin-left: 0; }
        .card.selected { transform: translateY(-30px); border: 3px solid #f59e0b; }
        .card.red { color: var(--danger); }
        .card .v { font-size: 24px; font-weight: 800; line-height: 1; }
        .card.back { background: #1e293b; border: 1px solid #334155; }

        /* æ¡Œé¢åŒº */
        #desk { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .desk-slot { height: 120px; display: flex; justify-content: center; align-items: center; width: 100%; }
        .status-text { font-size: 24px; font-weight: bold; color: #64748b; }
    </style>
</head>
<body>

<div id="stage">
    <div id="header">
        <div style="color: var(--gold);">1V1 æ¨¡å¼ (ä¸€å‰¯ç‰Œ)</div>
        <div id="comp-info">ç”µè„‘: 27 å¼ </div>
        <button onclick="initGame()" style="padding: 4px 12px; font-size: 12px;">é‡æ–°å¼€å§‹</button>
    </div>

    <div id="hand-1" class="hand"></div>
    
    <div id="desk">
        <div id="desk-1" class="desk-slot"></div>
        <div id="desk-0" class="desk-slot"></div>
    </div>

    <div class="btn-group" id="ui">
        <button id="btn-play" onclick="handlePlay()">å‡ºç‰Œ</button>
        <button id="btn-pass" onclick="handlePass()">ä¸è¦</button>
    </div>
    
    <div id="hand-0" class="hand"></div>
</div>

<script>
const POWER = { '3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':10,'J':11,'Q':12,'K':13,'A':14,'2':15,'å°ç‹':16,'å¤§ç‹':17 };
let G = { hands: [[], []], last: null, turn: 0, selected: new Set() };

function initGame() {
    let deck = [];
    for(let v in POWER) {
        if(v.includes('ç‹')) deck.push({v, p:POWER[v], s:'ğŸƒ', c:v==='å¤§ç‹'?'red':'black'});
        else ['â™ ','â™¥','â™£','â™¦'].forEach(s => deck.push({v, p:POWER[v], s, c:(s==='â™¥'||s==='â™¦'?'red':'black')}));
    }
    deck.sort(() => Math.random() - 0.5);
    
    G.hands = [
        deck.slice(0, 27).sort((a,b)=>b.p-a.p),
        deck.slice(27, 54).sort((a,b)=>b.p-a.p)
    ];
    G.last = null; G.turn = 0; G.selected.clear();
    
    document.getElementById('desk-0').innerHTML = "";
    document.getElementById('desk-1').innerHTML = "";
    renderAll();
}

function getInfo(cards) {
    if(!cards.length) return null;
    let counts = {};
    cards.forEach(c => counts[c.p] = (counts[c.p] || 0) + 1);
    let sorted = Object.entries(counts).map(e=>({p:Number(e[0]), c:e[1]})).sort((a,b)=>b.c - a.c || b.p - a.p);
    let len = cards.length;
    let main = sorted[0];

    if(main.c === 4 && len === 4) return { type: 'bomb', p: main.p, len: 4 };
    if(len === 2 && cards[0].p >= 16 && cards[1].p >= 16) return { type: 'bomb', p: 99, len: 2 };
    if(len === 1) return { type: 'single', p: main.p, len: 1 };
    if(len === 2 && main.c === 2) return { type: 'pair', p: main.p, len: 2 };
    if(len === 3 && main.c === 3) return { type: 'trio', p: main.p, len: 3 };
    
    if(len >= 5 && sorted.every(e => e.c === 1)) {
        let ps = sorted.map(e=>e.p).sort((a,b)=>a-b);
        if(ps[len-1] < 15 && ps[len-1]-ps[0] === len-1) return { type: 'straight', p: ps[0], len };
    }
    return null;
}

function handlePlay() {
    if(G.turn !== 0) return;
    let cards = Array.from(G.selected).map(i => G.hands[0][i]);
    let info = getInfo(cards);
    
    if(!info) {
        alert("ä¸ç¬¦åˆä»»ä½•ç‰Œå‹ï¼");
        return;
    }

    // å‹ç‰Œé€»è¾‘
    if(G.last && G.last.player !== 0) {
        let l = getInfo(G.last.cards);
        if(info.type === 'bomb') {
            if(l.type === 'bomb' && info.p <= l.p) { alert("ç‚¸å¼¹ä¸å¤Ÿå¤§"); return; }
        } else {
            if(info.type !== l.type || info.len !== l.len) { alert("ç‰Œå‹æˆ–å¼ æ•°ä¸åŒ¹é…"); return; }
            if(info.p <= l.p) { alert("ç‰Œç‚¹æ•°ä¸å¤Ÿå¤§"); return; }
        }
    }

    if(info.type === 'bomb') triggerEffects();
    execute(cards);
}

function triggerEffects() {
    const s = document.getElementById('stage');
    s.classList.add('bomb-shake', 'bomb-flash');
    setTimeout(() => s.classList.remove('bomb-shake', 'bomb-flash'), 500);
}

function execute(cards) {
    // ä»æ‰‹ç‰Œç§»é™¤
    G.hands[G.turn] = G.hands[G.turn].filter(c => !cards.includes(c));
    G.last = { player: G.turn, cards };
    
    // æ¸²æŸ“æ¡Œé¢å‡ºç‰Œ
    document.getElementById(`desk-${G.turn}`).innerHTML = cards.map(c => `
        <div class="card ${c.c}" style="margin-left:-50px; transform:scale(0.85); cursor:default">
            <span class="v">${c.v}</span><span>${c.s}</span>
        </div>
    `).join('');
    
    if(G.hands[G.turn].length === 0) {
        setTimeout(() => { alert(G.turn === 0 ? "æ­å–œï¼Œä½ èµ¢äº†ï¼" : "ç”µè„‘èµ¢äº†ï¼"); initGame(); }, 100);
        return;
    }
    
    G.selected.clear();
    nextTurn();
}

function handlePass() {
    if(!G.last || G.last.player === 0) return; // å¿…é¡»å‡ºç‰Œ
    document.getElementById(`desk-0`).innerHTML = '<span class="status-text">ä¸è¦</span>';
    nextTurn();
}

function nextTurn() {
    G.turn = 1 - G.turn;
    document.getElementById(`desk-${G.turn}`).innerHTML = ""; // æ¸…ç©ºå¯¹æ–¹ä¹‹å‰çš„å‡ºç‰Œ
    renderAll();
    if(G.turn === 1) setTimeout(aiPlay, 1000);
}

function aiPlay() {
    const hand = G.hands[1];
    let toPlay = [];
    
    if(!G.last || G.last.player === 1) {
        // AI ä¸»åŠ¨å‡ºç‰Œï¼šä¼˜å…ˆå‡ºæœ€å°çš„å•å¼ 
        toPlay = [hand[hand.length-1]];
    } else {
        const l = getInfo(G.last.cards);
        // AI å¯»æ‰¾èƒ½å‹è¿‡çš„æœ€å°ç‰Œ
        for(let n=1; n<=4; n++) { // éå†å¯èƒ½é•¿åº¦
            for(let i=hand.length-n; i>=0; i--) {
                let sub = hand.slice(i, i+n);
                let info = getInfo(sub);
                if(info && (info.type === l.type || info.type === 'bomb') && (info.len === l.len || info.type === 'bomb')) {
                    if(info.type === 'bomb' && l.type !== 'bomb') { toPlay = sub; break; }
                    if(info.p > l.p) { toPlay = sub; break; }
                }
            }
            if(toPlay.length) break;
        }
    }

    if(toPlay.length) {
        if(getInfo(toPlay).type === 'bomb') triggerEffects();
        execute(toPlay);
    } else {
        document.getElementById(`desk-1`).innerHTML = '<span class="status-text">ä¸è¦</span>';
        nextTurn();
    }
}

function renderAll() {
    const h0 = document.getElementById('hand-0');
    h0.innerHTML = G.hands[0].map((c, i) => `
        <div class="card ${c.c} ${G.selected.has(i)?'selected':''}" onclick="toggleCard(${i})">
            <span class="v">${c.v}</span><span>${c.s}</span>
        </div>
    `).join('');
    
    document.getElementById('hand-1').innerHTML = G.hands[1].map(() => `<div class="card back" style="margin-left:-65px"></div>`).join('');
    document.getElementById('comp-info').innerText = `ç”µè„‘: ${G.hands[1].length} å¼ `;
    document.getElementById('ui').className = G.turn === 0 ? 'btn-group active' : 'btn-group';
    document.getElementById('btn-pass').disabled = !G.last || G.last.player === 0;
}

function toggleCard(i) {
    if(G.turn !== 0) return;
    if(G.selected.has(i)) G.selected.delete(i); else G.selected.add(i);
    renderAll();
}

// å¯åŠ¨
initGame();
</script>
</body>
</html>
