<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>äº”äººæ–—åœ°ä¸» (ä¸¤å‰¯ç‰Œä¸“ä¸šç‰ˆ)</title>
    <style>
        :root { --bg: #0a3d1d; --gold: #ffd700; --card-w: 70px; --card-h: 100px; }
        body { margin: 0; background: var(--bg); font-family: "Segoe UI", sans-serif; color: white; overflow: hidden; }
        
        /* é¡¶éƒ¨çŠ¶æ€ */
        #header { height: 50px; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: space-around; font-size: 14px; }
        .dz-info { border: 1px solid var(--gold); padding: 2px 10px; border-radius: 4px; display: flex; gap: 5px; }

        /* 5äººç¯å½¢å¸ƒå±€åŒºåŸŸ */
        #stage { height: calc(100vh - 50px); position: relative; }
        .player-tag { position: absolute; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 10px; font-size: 12px; z-index: 5; border: 1px solid #555; }
        
        /* ç©å®¶ä½ç½®å®šä¹‰ */
        .pos-1 { left: 20px; top: 50%; transform: translateY(-50%); } /* å·¦äºŒ */
        .pos-2 { left: 150px; top: 15%; } /* å·¦ä¸€ */
        .pos-3 { right: 150px; top: 15%; } /* å³ä¸€ */
        .pos-4 { right: 20px; top: 50%; transform: translateY(-50%); } /* å³äºŒ */
        
        /* æ‰‹ç‰Œä¸æ¡Œé¢ */
        .hand { position: absolute; display: flex; justify-content: center; }
        #hand-0 { bottom: 20px; width: 100%; height: var(--card-h); z-index: 100; }
        .comp-hand { font-size: 12px; color: #ccc; }

        .card {
            width: var(--card-w); height: var(--card-h); background: white; border-radius: 5px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3); color: black; padding: 4px;
            box-sizing: border-box; display: flex; flex-direction: column;
            margin-left: -50px; transition: 0.2s; border: 1px solid #999; cursor: pointer;
        }
        #hand-0 .card:first-child { margin-left: 0; }
        .card.selected { transform: translateY(-25px); border: 3px solid #ff4400; }
        .card.red { color: #d32f2f; }
        .card.back { background: #2c3e50; border: 1px solid #fff; }

        /* å‡ºç‰ŒåŒº (5ä¸ª) */
        .desk { position: absolute; display: flex; justify-content: center; width: 300px; height: 100px; transform: translateX(-50%); left: 50%; }
        #desk-0 { bottom: 160px; }
        #desk-1 { left: 220px; top: 50%; }
        #desk-2 { left: 350px; top: 25%; }
        #desk-3 { right: 50px; top: 25%; }
        #desk-4 { right: -80px; top: 50%; }

        #controls { position: absolute; bottom: 135px; width: 100%; display: flex; justify-content: center; gap: 15px; visibility: hidden; }
        button { padding: 8px 20px; border-radius: 15px; border: none; background: var(--gold); font-weight: bold; cursor: pointer; }
        .msg { font-size: 20px; color: var(--gold); font-weight: bold; text-shadow: 1px 1px 2px #000; }
    </style>
</head>
<body>

<div id="header">
    <div>æ¨¡å¼: 5äºº/2å‰¯ç‰Œ</div>
    <div id="dz-area" class="dz-info">åœ°ä¸»ç‰ŒåŠ è½½ä¸­...</div>
    <div>éš¾åº¦: <select id="ai-level"><option value="3">è€æ‰‹</option><option value="6">é­”é¬¼</option></select></div>
    <button onclick="initGame()">é‡æ–°å‘ç‰Œ</button>
</div>

<div id="stage">
    <div class="player-tag pos-1">ç”µè„‘1: <span id="cnt-1">21</span>å¼ </div>
    <div class="player-tag pos-2">ç”µè„‘2: <span id="cnt-2">21</span>å¼ </div>
    <div class="player-tag pos-3">ç”µè„‘3: <span id="cnt-3">21</span>å¼ </div>
    <div class="player-tag pos-4">ç”µè„‘4: <span id="cnt-4">21</span>å¼ </div>

    <div id="desk-1" class="desk"></div>
    <div id="desk-2" class="desk"></div>
    <div id="desk-3" class="desk"></div>
    <div id="desk-4" class="desk"></div>
    <div id="desk-0" class="desk"></div>

    <div id="controls">
        <button onclick="handlePlay()">å‡ºç‰Œ</button>
        <button id="btn-pass" onclick="handlePass()">ä¸è¦</button>
    </div>

    <div id="hand-0" class="hand"></div>
</div>

<script>
const VALUES = { '3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':10,'J':11,'Q':12,'K':13,'A':14,'2':15,'å°ç‹':16,'å¤§ç‹':17 };
let game = { hands: [[],[],[],[],[]], last: null, turn: 0, selected: new Set(), dizhu: 0 };

function initGame() {
    let deck = [];
    // ç”Ÿæˆä¸¤å‰¯ç‰Œ
    for(let i=0; i<2; i++) {
        for(let v in VALUES) {
            if(v.includes('ç‹')) deck.push({v, p:VALUES[v], s:'ğŸƒ', c:v==='å¤§ç‹'?'red':'black'});
            else ['â™ ','â™¥','â™£','â™¦'].forEach(s => deck.push({v, p:VALUES[v], s, c:(s==='â™¥'||s==='â™¦'?'red':'black')}));
        }
    }
    deck.sort(() => Math.random() - 0.5);

    // 5äººæ¯äºº21å¼ ï¼Œç•™3å¼ åœ°ä¸»ç‰Œ (21*5 + 3 = 108)
    game.hands = [
        deck.slice(0, 21).sort((a,b)=>b.p-a.p),
        deck.slice(21, 42).sort((a,b)=>b.p-a.p),
        deck.slice(42, 63).sort((a,b)=>b.p-a.p),
        deck.slice(63, 84).sort((a,b)=>b.p-a.p),
        deck.slice(84, 105).sort((a,b)=>b.p-a.p)
    ];
    let dzCards = deck.slice(105);
    game.dizhu = 0; // é»˜è®¤ç©å®¶æ˜¯åœ°ä¸»
    game.hands[0] = [...game.hands[0], ...dzCards].sort((a,b)=>b.p-a.p);
    
    game.last = null; game.turn = 0; game.selected.clear();
    
    document.getElementById('dz-area').innerHTML = dzCards.map(c=>`<span style="color:${c.c}">${c.v}</span>`).join(' ');
    renderAll();
    checkTurn();
}

function getCardsInfo(cards) {
    if(!cards.length) return null;
    let counts = {};
    cards.forEach(c => counts[c.p] = (counts[c.p] || 0) + 1);
    let sorted = Object.entries(counts).map(e=>({p:Number(e[0]), c:e[1]})).sort((a,b)=>b.c - a.c || b.p - a.p);
    let len = cards.length;
    let main = sorted[0];

    // åŸºç¡€ç‰Œå‹
    if(sorted.length === 1) {
        if(len <= 3) return { type: ['single','pair','trio'][len-1], p: main.p, len };
        if(len >= 4) return { type: 'bomb', p: main.p, len: len + 10 }; // ä¸¤å‰¯ç‰Œï¼Œç‚¸å¼¹é•¿åº¦å³å¨åŠ›
    }
    
    // ç‹ç‚¸ (ä¸¤å‰¯ç‰Œæ”¯æŒ 2-4 å¼ ç‹ç»„æˆçš„è¶…çº§ç‚¸å¼¹)
    let jokerCount = cards.filter(c => c.p >= 16).length;
    if(jokerCount === len && len >= 2) return { type: 'bomb', p: 99, len: len + 20 };

    // ä¸‰å¸¦/å››å¸¦
    if(len === 4 && main.c === 3) return { type: 'trio_1', p: main.p, len: 4 };
    if(len === 5 && main.c === 3 && sorted[1].c === 2) return { type: 'trio_2', p: main.p, len: 5 };
    if(len === 6 && main.c === 4) return { type: 'four_2', p: main.p, len: 6 };

    // é¡ºå­/è¿å¯¹ (é€»è¾‘åŒå•å‰¯)
    if(len >= 5 && sorted.every(e => e.c === 1)) {
        let ps = sorted.map(e=>e.p).sort((a,b)=>a-b);
        if(ps[len-1] < 15 && ps[len-1]-ps[0] === len-1) return { type: 'straight', p: ps[0], len };
    }

    return null;
}

function renderAll() {
    const h0 = document.getElementById('hand-0');
    h0.innerHTML = "";
    game.hands[0].forEach((c, i) => {
        let div = document.createElement('div');
        div.className = `card ${c.c} ${game.selected.has(i)?'selected':''}`;
        div.innerHTML = `<span style="font-size:18px;font-weight:bold">${c.v}</span><span style="align-self:flex-end">${c.s}</span>`;
        div.onclick = () => { game.selected.has(i)?game.selected.delete(i):game.selected.add(i); renderAll(); };
        h0.appendChild(div);
    });

    for(let i=1; i<=4; i++) document.getElementById(`cnt-${i}`).innerText = game.hands[i].length;
    document.getElementById('controls').style.visibility = game.turn === 0 ? 'visible' : 'hidden';
    document.getElementById('btn-pass').disabled = !game.last || game.last.player === 0;
}

function handlePlay() {
    let cards = Array.from(game.selected).map(i => game.hands[0][i]);
    let info = getCardsInfo(cards);
    if(!info) return alert("éæ³•ç‰Œå‹");

    if(game.last && game.last.player !== 0) {
        let lastInfo = getCardsInfo(game.last.cards);
        if(info.type === 'bomb') {
            if(lastInfo.type === 'bomb' && info.len <= lastInfo.len) return alert("ç‚¸å¼¹ä¸å¤Ÿå¤§");
        } else {
            if(info.type !== lastInfo.type || info.len !== lastInfo.len || info.p <= lastInfo.p) return alert("å‹ä¸ä½");
        }
    }
    execute(cards);
}

function handlePass() {
    document.getElementById(`desk-${game.turn}`).innerHTML = '<span class="msg">ä¸è¦</span>';
    nextTurn();
}

function execute(cards) {
    game.hands[game.turn] = game.hands[game.turn].filter(c => !cards.includes(c));
    game.last = { player: game.turn, cards };
    document.getElementById(`desk-${game.turn}`).innerHTML = cards.map(c => 
        `<div class="card ${c.c}" style="margin-left:-55px; transform:scale(0.8)"><span style="font-size:18px;font-weight:bold">${c.v}</span><span>${c.s}</span></div>`
    ).join('');
    
    if(game.hands[game.turn].length === 0) {
        alert(game.turn === 0 ? "åœ°ä¸»èƒœï¼" : "å†œæ°‘èƒœï¼");
        initGame();
        return;
    }
    game.selected.clear();
    nextTurn();
}

function nextTurn() {
    game.turn = (game.turn + 1) % 5;
    document.getElementById(`desk-${game.turn}`).innerHTML = "";
    renderAll();
    checkTurn();
}

function checkTurn() {
    if(game.turn !== 0) {
        setTimeout(aiThink, 800);
    }
}

function aiThink() {
    let hand = game.hands[game.turn];
    let toPlay = [];
    
    if(!game.last || game.last.player === game.turn) {
        toPlay = [hand[hand.length-1]]; // å‡ºä¸€å¼ æœ€å°çš„
    } else {
        let lastInfo = getCardsInfo(game.last.cards);
        // AI ç®€åŒ–åŒ¹é…é€»è¾‘ï¼šå°è¯•å•å¼ æˆ–å¯¹å­
        if(lastInfo.type === 'single') {
            let bigger = hand.filter(c => c.p > lastInfo.p).reverse();
            if(bigger.length) toPlay = [bigger[0]];
        } else if(lastInfo.type === 'pair') {
            for(let i=0; i<hand.length-1; i++) {
                if(hand[i].p === hand[i+1].p && hand[i].p > lastInfo.p) {
                    toPlay = [hand[i], hand[i+1]]; break;
                }
            }
        }
        // éš¾åº¦è¾ƒé«˜æ—¶ï¼ŒAIä¼šè€ƒè™‘ç‚¸å¼¹
        if(!toPlay.length && lastInfo.type !== 'bomb' && hand.length > 5) {
            // ç®€å•æ‰¾ç‚¸å¼¹
            let counts = {}; hand.forEach(c => counts[c.p] = (counts[c.p]||0)+1);
            for(let p in counts) if(counts[p] >= 4) { toPlay = hand.filter(c=>c.p==p); break; }
        }
    }

    if(toPlay.length) execute(toPlay);
    else handlePass();
}

initGame();
</script>
</body>
</html>
